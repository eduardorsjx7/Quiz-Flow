generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env(DATABASE_URL)
}

model Usuario {
  id        Int      @id @default(autoincrement())
  nome      String
  email     String?  @unique
  matricula String?
  senha     String?
  tipo      TipoUsuario @default(COLABORADOR)
  grupoId   Int?     // Departamento/grupo do colaborador
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  grupo             Grupo?   @relation(fields: [grupoId], references: [id], onDelete: SetNull)
  tentativas         TentativaQuiz[]
  fasesDesbloqueadas DesbloqueioFase[]
  atribuicoes        AtribuicaoQuiz[]

  @@map("usuarios")
}

enum TipoUsuario {
  ADMINISTRADOR
  COLABORADOR
}

model Jornada {
  id          Int      @id @default(autoincrement())
  titulo      String
  descricao   String?
  ordem       Int      @default(0)
  ativo       Boolean  @default(true)
  criadoPor   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fases       Fase[]

  @@map("jornadas")
}

model Fase {
  id          Int      @id @default(autoincrement())
  jornadaId   Int      // Fase pertence a uma jornada
  titulo      String
  descricao   String?
  ordem       Int      @default(0)
  ativo       Boolean  @default(true)
  criadoPor   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jornada     Jornada  @relation(fields: [jornadaId], references: [id], onDelete: Cascade)
  quizzes     Quiz[]
  desbloqueios DesbloqueioFase[]

  @@map("fases")
}

model Quiz {
  id          Int      @id @default(autoincrement())
  titulo      String
  descricao   String?
  faseId      Int
  ordem       Int      @default(0)
  ativo       Boolean  @default(true)
  pontosBase  Int      @default(100)
  tags        String?  // Tags/temas separadas por vírgula
  dataInicio  DateTime? // Data de início da disponibilidade
  dataFim     DateTime? // Data de fim da disponibilidade
  criadoPor   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fase        Fase     @relation(fields: [faseId], references: [id], onDelete: Cascade)
  perguntas   Pergunta[]
  tentativas  TentativaQuiz[]
  atribuicoes AtribuicaoQuiz[]

  @@map("quizzes")
}

model DesbloqueioFase {
  id          Int      @id @default(autoincrement())
  faseId      Int
  usuarioId   Int
  faseAtual   Boolean  @default(false) // Indica se esta é a fase atual do PDC do usuário
  desbloqueadoPor Int?
  desbloqueadoEm DateTime @default(now())
  createdAt   DateTime @default(now())

  fase        Fase     @relation(fields: [faseId], references: [id], onDelete: Cascade)
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([faseId, usuarioId])
  @@map("desbloqueios_fase")
}

model Grupo {
  id          Int      @id @default(autoincrement())
  nome        String
  descricao   String?
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  usuarios    Usuario[]
  atribuicoes AtribuicaoQuiz[]

  @@map("grupos")
}

model AtribuicaoQuiz {
  id          Int      @id @default(autoincrement())
  quizId      Int
  usuarioId   Int?     // Se null, é atribuição por grupo
  grupoId     Int?
  atribuidoPor Int?
  atribuidoEm DateTime @default(now())
  createdAt   DateTime @default(now())

  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  usuario     Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  grupo       Grupo?   @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("atribuicoes_quiz")
}

model Pergunta {
  id          Int      @id @default(autoincrement())
  quizId      Int
  texto       String
  tempoSegundos Int    @default(30)
  ordem       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  alternativas Alternativa[]
  respostas   Resposta[]

  @@map("perguntas")
}

model Alternativa {
  id          Int      @id @default(autoincrement())
  perguntaId  Int
  texto       String
  correta     Boolean  @default(false)
  ordem       Int
  createdAt   DateTime @default(now())

  pergunta    Pergunta @relation(fields: [perguntaId], references: [id], onDelete: Cascade)

  @@map("alternativas")
}

model TentativaQuiz {
  id          Int      @id @default(autoincrement())
  quizId      Int
  usuarioId   Int      // Sempre vinculado a um usuário específico
  status      StatusTentativa @default(EM_ANDAMENTO)
  iniciadaEm  DateTime @default(now())
  finalizadaEm DateTime?
  pontuacaoTotal Int   @default(0)
  tempoTotal  Int     @default(0)
  posicaoRanking Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  respostas   Resposta[]

  @@unique([quizId, usuarioId]) // Um usuário pode ter apenas uma tentativa por quiz
  @@map("tentativas_quiz")
}

enum StatusTentativa {
  EM_ANDAMENTO
  FINALIZADA
  ABANDONADA
}

model Resposta {
  id          Int      @id @default(autoincrement())
  tentativaId Int
  perguntaId  Int
  alternativaId Int?
  tempoResposta Int    // Tempo em segundos que levou para responder
  pontuacao   Int      @default(0)
  acertou     Boolean  @default(false)
  tempoEsgotado Boolean @default(false) // Se o tempo expirou antes de responder
  respondidaEm DateTime @default(now())

  tentativa   TentativaQuiz @relation(fields: [tentativaId], references: [id], onDelete: Cascade)
  pergunta    Pergunta      @relation(fields: [perguntaId], references: [id], onDelete: Cascade)

  @@map("respostas")
}

